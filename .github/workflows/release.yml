name: Automated Release and Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 5.0.0)'
        required: true
        default: '5.0.0'

jobs:
  build-and-package:
    name: Build and Create Release Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, bcmath
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Install NPM dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build:prod

      - name: Create release package
        run: |
          chmod +x scripts/create-release.sh
          scripts/create-release.sh ${{ steps.version.outputs.version }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: release/*.tar.gz*
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.tar.gz
            release/*.checksums
          body: |
            ## ChiBank v${{ steps.version.outputs.version }} Release
            
            ### ğŸ“¦ è½¯ä»¶åŒ…è¯´æ˜ (Package Information)
            
            è¿™æ˜¯ ChiBank v${{ steps.version.outputs.version }} çš„å®Œæ•´å‘è¡ŒåŒ…ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å’Œä¾èµ–ã€‚
            
            ### ğŸš€ å¿«é€Ÿéƒ¨ç½² (Quick Deployment)
            
            #### Docker éƒ¨ç½²ï¼ˆæ¨èï¼‰
            ```bash
            # 1. ä¸‹è½½å¹¶è§£å‹è½¯ä»¶åŒ…
            tar -xzf chibank-v${{ steps.version.outputs.version }}-*.tar.gz
            cd chibank-v${{ steps.version.outputs.version }}-*
            
            # 2. é…ç½®ç¯å¢ƒ
            cp .env.example .env
            # ç¼–è¾‘ .env æ–‡ä»¶
            
            # 3. å¯åŠ¨ Docker
            docker-compose up -d
            
            # 4. åˆå§‹åŒ–æ•°æ®åº“
            docker-compose exec app php artisan migrate --force
            docker-compose exec app php artisan db:seed
            
            # 5. è®¿é—®åº”ç”¨
            # æµè§ˆå™¨æ‰“å¼€: http://localhost
            ```
            
            #### ä¼ ç»Ÿéƒ¨ç½²
            ```bash
            # 1. ä¸‹è½½å¹¶è§£å‹è½¯ä»¶åŒ…
            tar -xzf chibank-v${{ steps.version.outputs.version }}-*.tar.gz
            cd chibank-v${{ steps.version.outputs.version }}-*
            
            # 2. é…ç½®ç¯å¢ƒ
            cp .env.example .env
            php artisan key:generate
            
            # 3. é…ç½®æ•°æ®åº“
            # ç¼–è¾‘ .env æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
            
            # 4. è¿è¡Œè¿ç§»
            php artisan migrate --force
            php artisan db:seed
            
            # 5. ä¼˜åŒ–ç¼“å­˜
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # 6. å¯åŠ¨åº”ç”¨
            php artisan serve
            ```
            
            ### ğŸ“š æ–‡æ¡£ (Documentation)
            
            - [å®Œæ•´åˆ†ææŠ¥å‘Š](./COMPREHENSIVE_ANALYSIS_REPORT_CN.md)
            - [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT.md)
            - [æ“ä½œæ‰‹å†Œ](./docs/zh-CN/æ“ä½œæ–‡æ¡£.md)
            - [ç³»ç»Ÿåˆ†æ](./SYSTEM_ANALYSIS_REPORT.md)
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½ (Key Features)
            
            - âœ… å¤šè§’è‰²ç³»ç»Ÿ (ç”¨æˆ·ã€ä»£ç†ã€å•†æˆ·ã€ç®¡ç†å‘˜)
            - âœ… 12ä¸ªæ”¯ä»˜ç½‘å…³é›†æˆ
            - âœ… Fiat24 åŒºå—é“¾é“¶è¡Œé›†æˆ
            - âœ… å¤šè´§å¸æ”¯æŒ
            - âœ… è™šæ‹Ÿå¡ç³»ç»Ÿ
            - âœ… æ”¯ä»˜é“¾æ¥
            - âœ… æ‰‹æœºå……å€¼
            - âœ… KYC éªŒè¯
            - âœ… åŒå› ç´ è®¤è¯ (2FA)
            - âœ… RESTful API
            - âœ… Flutter ç§»åŠ¨åº”ç”¨
            
            ### ğŸ” å®‰å…¨æ€§ (Security)
            
            - æ ¡éªŒå’Œæ–‡ä»¶å·²åŒ…å«åœ¨å‘è¡ŒåŒ…ä¸­
            - è¯·åœ¨éƒ¨ç½²å‰éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            
            ### ğŸ“ æ”¯æŒ (Support)
            
            å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—®:
            - [GitHub Issues](https://github.com/hhongli1979-coder/chibank999/issues)
            - [æ–‡æ¡£ä¸­å¿ƒ](./docs/)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker-image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-package
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            chibank/qrpay:latest
            chibank/qrpay:${{ steps.version.outputs.version }}
          labels: |
            org.opencontainers.image.title=ChiBank
            org.opencontainers.image.description=Enterprise-grade digital payment gateway
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true

  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [build-and-package, build-docker-image]
    if: success()
    
    steps:
      - name: Deployment notification
        run: |
          echo "âœ… ChiBank å‘è¡ŒåŒ…åˆ›å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ è½¯ä»¶åŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ğŸ³ Docker é•œåƒå·²æ¨é€åˆ° Docker Hub"
          echo ""
          echo "éƒ¨ç½²è¯´æ˜ï¼š"
          echo "1. ä» GitHub Releases ä¸‹è½½è½¯ä»¶åŒ…"
          echo "2. æˆ–ä½¿ç”¨ Docker: docker pull chibank/qrpay:latest"
          echo "3. æŒ‰ç…§å‘è¡Œè¯´æ˜è¿›è¡Œéƒ¨ç½²"
