# 构建错误修复 / Build Error Fix

## 问题：npm run build 失败

### 快速修复（复制粘贴运行）

```bash
# 1. 清理
rm -rf node_modules package-lock.json
npm cache clean --force

# 2. 重新安装
npm install --legacy-peer-deps

# 3. 构建
npm run build
```

---

## 如果还是失败，用这个完整的 package.json

```bash
cat > package.json << 'EOF'
{
    "private": true,
    "type": "module",
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "build:prod": "vite build --mode production",
        "typecheck": "tsc --noEmit",
        "deploy": "./scripts/deploy.sh",
        "docker:build": "./scripts/docker-build.sh",
        "docker:push": "./scripts/docker-build.sh --push",
        "release": "./scripts/create-release.sh"
    },
    "dependencies": {
        "react": "^18.2.0",
        "react-dom": "^18.2.0"
    },
    "devDependencies": {
        "@popperjs/core": "^2.11.6",
        "@types/react": "^18.2.0",
        "@types/react-dom": "^18.2.0",
        "@vitejs/plugin-react": "^4.3.0",
        "axios": "^1.6.0",
        "bootstrap": "^5.3.0",
        "laravel-vite-plugin": "^1.0.0",
        "lodash": "^4.17.21",
        "postcss": "^8.4.31",
        "sass": "^1.69.0",
        "typescript": "^5.3.0",
        "vite": "^5.4.0"
    }
}
EOF
```

---

## 完整的 vite.config.js

```bash
cat > vite.config.js << 'EOF'
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';
import react from '@vitejs/plugin-react';
import { fileURLToPath, URL } from 'node:url';

export default defineConfig({
    plugins: [
        laravel({
            input: [
                'resources/sass/app.scss',
                'resources/js/app.js',
                'src/index.ts',
            ],
            refresh: true,
        }),
        react(),
    ],
    resolve: {
        alias: {
            '@': fileURLToPath(new URL('./src', import.meta.url)),
            '@components': fileURLToPath(new URL('./src/components', import.meta.url)),
        },
    },
});
EOF
```

---

## 然后重新安装和构建

```bash
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps
npm run build
```

---

## 检查文件

```bash
# 验证 JSON 格式
node -e "JSON.parse(require('fs').readFileSync('package.json'))" && echo "✓ package.json OK"

# 验证 vite.config.js 语法
node --check vite.config.js && echo "✓ vite.config.js OK"
```

---

## 常见错误和解决方案

### 错误1: `__dirname is not defined`
**解决**: 已修复，使用 `import.meta.url`

### 错误2: `Cannot find module 'vite'`
**解决**: 
```bash
npm install --legacy-peer-deps
```

### 错误3: `Unexpected token`
**解决**: 确保 package.json 有 `"type": "module"`

### 错误4: 版本冲突
**解决**: 
```bash
npm install --legacy-peer-deps --force
```

---

## 验证构建成功

```bash
# 应该看到 public/build 目录
ls -la public/build/
```

成功后会看到编译好的 CSS 和 JS 文件。
